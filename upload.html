<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Uploader</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Data Uploader</h1>
        <select id="fileType">
            <option value="regionalfile">Regional File</option>
            <option value="hofile">HO File</option>
        </select>
        <input type="file" id="fileInput" accept=".xlsx">
        <button id="uploadBtn">Upload</button>
        <div id="errorMsg"></div>
        <hr>
        <h2>Delete All Data</h2>
        <input type="password" id="deletePass" placeholder="Password">
        <button id="deleteBtn">Delete</button>
        <button onclick="localStorage.clear(); window.location.href='index.html'">Logout</button>
        <button onclick="window.location.href='choose_dashboard.html'">Go to Dashboard</button>
    </div>
    <script>
        const supabase = Supabase.createClient('https://nfwuztbyvbasaqbpyojr.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5md3V6dGJ5dmJhc2FxYnB5b2pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjQ4NzcsImV4cCI6MjA3MDY0MDg3N30.DhEvb6H9kczxdD1N9_d6DmDkk6_9sUGZfKSFk7hYLdQ');

        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const file = document.getElementById('fileInput').files[0];
            const fileType = document.getElementById('fileType').value;
            if (!file) return alert('Select file');
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                const headers = rows[0];
                const expectedHeaders = ['Team','BU','Zone','Brick','ChemistName','TM','ASM','SM','ValueSales','ValueTarget','UnitSales','UnitTarget','ValueLYSales','UnitLYSales','Date','Month','Day','Product','Brand'];
                if (!expectedHeaders.every(h => headers.includes(h))) {
                    document.getElementById('errorMsg').textContent = 'Missing headers: ' + expectedHeaders.filter(h => !headers.includes(h)).join(', ');
                    return;
                }
                const uploadData = [];
                const errors = [];
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length < expectedHeaders.length) {
                        errors.push(`Row ${i+1}: Incomplete data`);
                        continue;
                    }
                    const obj = {};
                    headers.forEach((h, idx) => obj[h] = row[idx]);
                    if (isNaN(obj.ValueSales) || obj.ValueSales < 0) errors.push(`Row ${i+1}: Invalid ValueSales`);
                    // Add similar validations for other numeric fields
                    obj.file_type = fileType;
                    uploadData.push(obj);
                }
                if (errors.length) {
                    document.getElementById('errorMsg').innerHTML = errors.join('<br>');
                    return;
                }
                const { error } = await supabase.from('sales_data').insert(uploadData);
                if (error) alert('Upload error: ' + error.message);
                else alert('Uploaded successfully');
            };
            reader.readAsBinaryString(file);
        });

        document.getElementById('deleteBtn').addEventListener('click', async () => {
            const pass = document.getElementById('deletePass').value;
            if (pass !== 'zam252459') return alert('Invalid password');
            const { error } = await supabase.from('sales_data').delete().neq('id', 0);  // Deletes all
            if (error) alert('Delete error: ' + error.message);
            else alert('Data deleted');
        });
    </script>
</body>
</html>